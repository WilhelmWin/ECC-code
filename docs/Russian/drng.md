# Документация для файла DRNG

## Откуда растут ноги?

### Дата публикации: 
17 октября 2018 года
### Оригинальная документация: 
[Intel Digital Random Number Generator (DRNG)](https://www.intel.com/content/dam/develop/external/us/en/documents/drng-software-implementation-guide-2-1-185467.pd)
### Как была получена: 
Предоставлена научным руководителем Милошом Друтаровски файл
с учебной программы по безопасности компьютерных систем `bps_ps_sem5`.

### Что изменено?

1. Все файлы были собраны в два файла `drng.c/drng.h`

## Описание

Этот файл содержит определения функций и макросов для работы с 
генерацией случайных чисел, используя различные методы, включая 
использование инструкции RDRAND (если поддерживается аппаратно). 
Целью является создание надежного источника случайных чисел для 
криптографических операций, таких как создание ключей и токенов 
безопасности.
Ключевые особенности:

- Использование инструкции `RDRAND` для аппаратной генерации 
случайных чисел.

- Функции для повторных попыток получения случайных чисел, если 
они не прошли проверку.

- Утилиты для преобразования случайных чисел в байтовые массивы.



### Используемые библиотеки:

- `stdint.h` - для работы с целыми числами
- `string.h` - для операции с памятью

### Зависимости от платформы:

Этот код может использовать инструкцию `RDRAND`, если она 
поддерживается процессором, и будет корректно работать в 
платформо-независимом коде, с минимальными изменениями для 
платформы.

## Аргументы и функциональность:

Функции в этом заголовочном файле выполняют следующие действия:
- `rdrand64_step(uint64_t *rand)` - генерация случайных чисел 
с помощью RDRAND.

- `rdrand64_retry(unsigned int retries, uint64_t *rand)` - 
повторные попытки генерации случайных чисел в случае ошибок.

- `rdrand_get_bytes(unsigned int n, unsigned char *dest)` - 
утилиты для упаковки и распаковки данных.


## Пример использования:
### 1. Для получения случайного числа:
```c
   uint64_t rand;
   int result = rdrand64_step(&rand);
   if (result == 0) {
   printf("Сгенерированное случайное число: %llu\n", rand);
   } else {
   printf("Ошибка при генерации случайного числа\n");
   }
```

### 2. Для получения случайных байтов:
```c
   unsigned char bytes[32];
   unsigned int num_bytes = rdrand_get_bytes(32, bytes);
   printf("Сгенерировано %u случайных байтов\n", num_bytes);
```

### 3. Для выполнения повторных попыток генерации случайного числа:
```c
   uint64_t rand;
   int result = rdrand64_retry(10, &rand);  // Попытаться до 10 раз
   if (result == 0) {
   printf("Сгенерированное случайное число после повторных попыток: %llu\n", rand);
   } else {
   printf("Не удалось сгенерировать случайное число после 10 попыток\n");
   }
```
# Описание функций:
### `rdrand64_step(uint64_t *rand)`

- Эта функция генерирует одно случайное 64-битное число с использованием инструкции 
`RDRAND`. Она возвращает 0 при успешном завершении и ненулевое значение в случае ошибки.
- Функция вызывает инструкцию `RDRAND` для генерации случайного 64-битного числа.
При успешной генерации число сохраняется в указанный параметр rand.

### `rdrand64_retry(unsigned int retries, uint64_t *rand)`

- Эта функция выполняет генерацию случайных чисел с 
использованием `RDRAND` и повторяет попытку до retries 
раз, если генерация не удалась.
- Функция пытается несколько раз (в пределах заданного количества попыток) 
получить случайное число. Если генерация не удалась ни при одной из попыток,
функция возвращает ошибку.

### `rdrand_get_bytes(unsigned int n, unsigned char *dest)`

- Эта функция генерирует массив случайных байтов длиной 
`n` и сохраняет их в массив `dest`.
- Функция генерирует случайные байты с помощью `RDRAND`
и копирует их в массив dest. Процесс продолжается до тех 
пор, пока не будет сгенерировано `n` байтов.

# drng.c

## 1. `rdrand64_step` (Шаг генерации случайного числа)
```c
int rdrand64_step(uint64_t *rand)
{
if (__builtin_ia32_rdrand64_step(rand)) {
return 0;
}
return -1;  // Ошибка при генерации случайного числа
}
```
- В этой функции используется встроенная функция `GCC`
для вызова инструкции `RDRAND`, которая генерирует 64-битное 
случайное число, если оно доступно.

## 2. `rdrand64_retry` (Повторные попытки генерации случайного числа)
```c
int rdrand64_retry(unsigned int retries, uint64_t *rand)
{
int result;
for (unsigned int i = 0; i < retries; ++i) {
result = rdrand64_step(rand);
if (result == 0) {
return 0;  // Успех
}
}
return -1;  // Не удалось сгенерировать число после всех попыток
}
```
- Эта функция выполняет несколько попыток получения 
случайного числа с использованием функции `rdrand64_step`.

## 3. `rdrand_get_bytes` (Генерация случайных байтов)
```c
unsigned int rdrand_get_bytes(unsigned int n, unsigned char *dest)
{
unsigned int bytes_generated = 0;
uint64_t rand;
while (bytes_generated < n) {
if (rdrand64_step(&rand) == 0) {
unsigned char *ptr = (unsigned char *)&rand;
unsigned int to_copy = (n - bytes_generated > sizeof(rand)) ? sizeof(rand) : (n - bytes_generated);
memcpy(dest + bytes_generated, ptr, to_copy);
bytes_generated += to_copy;
}
}
return bytes_generated;
}
```
- Функция генерирует случайные байты с использованием инструкции 
`RDRAND` и записывает их в переданный массив `dest`.

# Заключение

Данный код предоставляет базовую функциональность для работы 
с цифровым генератором случайных чисел, используя инструкцию 
`RDRAND` на поддерживающих платформах. Он поддерживает простые 
операции, такие как генерация случайных чисел и байтов, а также
обработку ошибок и повторные попытки для увеличения надежности.
