# ========================================================================
# Компилятор и флаги
# ========================================================================

CC = gcc
CFLAGS = -Wall -Wextra -O2 -fstack-protector-strong -fPIE -D_FORTIFY_SOURCE=2
LDFLAGS = -pie -Wl,-z,relro -Wl,-z,now

# ========================================================================
# Названия исполняемых файлов
# ========================================================================

SERVER_TARGET = server       # Серверное приложение
CLIENT_TARGET = client       # Клиентское приложение

# ========================================================================
# Каталоги
# ========================================================================

ASCON_DIR = ASCON            # Каталог, содержащий код ASCON

# ========================================================================
# Исходные и объектные файлы
# ========================================================================

ECC_SRC = ECC.c              # Исходный файл модуля ECC
ECC_OBJ = ECC.o              # Объектный файл для ECC

ASCON_SRC = $(ASCON_DIR)/aead.c        # Исходный файл ASCON
ASCON_OBJ = $(ASCON_SRC:.c=.o)         # Соответствующий объектный файл

SERVER_SRC = server.c session.c drng.c error.c # Исходные файлы сервера
CLIENT_SRC = client.c session.c drng.c error.c # Исходные файлы клиента

SERVER_OBJ = $(SERVER_SRC:.c=.o)       # Объектные файлы для сервера
CLIENT_OBJ = $(CLIENT_SRC:.c=.o)       # Объектные файлы для клиента
COMMON_OBJ = session.o drng.o error.o  # Общие объектные файлы

# ========================================================================
# Статические библиотеки
# ========================================================================

LIBECC = libecc.a             # Статическая библиотека ECC
LIBASCON = libascon.a         # Статическая библиотека ASCON
LIBRARIES = $(LIBECC) $(LIBASCON)  # Список библиотек для линковки

# ========================================================================
# Флаги компоновщика и команды удаления файлов в зависимости от ОС
# ========================================================================

ifeq ($(OS), Windows_NT)
    LDFLAGS = -lws2_32        # Для Windows: добавить библиотеку сокетов
    RM = del /f /q            # Команда удаления для Windows
    NULL = nul                # Устройство-пустышка в Windows
else
    LDFLAGS =                 # Для Unix-подобных систем: дополнительных флагов нет
    RM = rm -f                # Команда удаления для Unix
    NULL = /dev/null          # Устройство-пустышка в Unix
endif

# ========================================================================
# Правило по умолчанию (сборка всего проекта)
# ========================================================================

all: $(LIBRARIES) $(SERVER_TARGET) $(CLIENT_TARGET) postbuild

# ========================================================================
# Сборка статических библиотек
# ========================================================================

$(LIBECC): $(ECC_OBJ)
	ar rcs $@ $^

$(LIBASCON): $(ASCON_OBJ)
	ar rcs $@ $^

# ========================================================================
# Сборка исполняемых файлов
# ========================================================================

$(SERVER_TARGET): $(SERVER_OBJ) $(LIBRARIES)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

$(CLIENT_TARGET): $(CLIENT_OBJ) $(LIBRARIES)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

# ========================================================================
# Шаблон для компиляции .c → .o
# ========================================================================

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# ========================================================================
# Очистка после сборки (временные файлы)
# ========================================================================

postbuild:
ifeq ($(OS), Windows_NT)
	-$(RM) ECC.o session.o drng.o error.o
	-$(RM) ASCON\\aead.o ASCON\\printstate.o
	-$(RM) server.o client.o
	-$(RM) $(LIBRARIES)
else
	$(RM) $(ECC_OBJ) $(COMMON_OBJ) $(ASCON_OBJ) $(SERVER_OBJ)
	$(RM) $(CLIENT_OBJ) $(LIBRARIES)
endif

# ========================================================================
# Команды очистки
# ========================================================================

clean:
ifeq ($(OS), Windows_NT)
	-$(RM) ASCON\\aead.o ASCON\\printstate.o
	-$(RM) $(LIBRARIES)
	-$(RM) $(SERVER_TARGET) $(CLIENT_TARGET) *.exe
else
	$(RM) $(ASCON_DIR)/*.o $(LIBRARIES) $(SERVER_TARGET) $(CLIENT_TARGET)
	$(RM) $(ECC_OBJ) $(COMMON_OBJ)  $(SERVER_OBJ) $(CLIENT_OBJ)
endif

distclean:
ifeq ($(OS), Windows_NT)
	-$(RM) *~ *.bak
else
	$(RM) *~ *.bak
endif
